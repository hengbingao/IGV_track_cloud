#!/usr/bin/env bash
set -e

# ================================================
# cloudigv — Cloud-based IGV track management tool
# ================================================
# Author: hengbin.gao
# Description:
#   A unified command-line tool for generating Dropbox URLs
#   and building IGV session XML files for cloud-hosted data.
# ================================================

# Get absolute path to src directory
script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")/../src" && pwd)"

# Help message
show_help() {
    echo "cloudigv — Cloud-based IGV track management tool"
    echo
    echo "Usage:"
    echo "  cloudigv -dropbox_URL --key <access_token> --folder <dropbox_folder> [--output <output_file>]"
    echo "  cloudigv -igv_session_xml -i <input_file> [-o <output_file>] [-g <genome>]"
    echo
    echo "Subcommands:"
    echo "  -dropbox_URL         Generate Dropbox direct download URLs for all files in a folder"
    echo "  -igv_session_xml     Generate IGV session XML file from URL list"
    echo
    echo "Options:"
    echo "  -k,  --key           Dropbox API access token"
    echo "  -f,  --folder        Dropbox folder path"
    echo "  -o,  --output        Output file name"
    echo "  -i,  --input         Input file containing URLs (tab-separated: name + URL)"
    echo "  -g,  --genome        Reference genome (default: hg38)"
    echo "  -h,  --help          Show this help message"
    echo
    echo "Examples:"
    echo "  cloudigv -dropbox_URL -k YOUR_TOKEN -f /CUTnTag/hs/ -o hs_links.txt"
    echo "  cloudigv -igv_session_xml -i hs_links.txt -o igv_session.xml -g hg38"
    echo
    echo "Note:"
    echo "  To use the Dropbox URL generator, install the dropbox SDK:"
    echo "        pip install dropbox"
    echo
    echo "  Create an app and access token at:"
    echo "        https://www.dropbox.com/developers/apps"
    echo
    echo "  Make sure your app has the 'sharing.write' permission enabled!"
    echo
}

# Show help if requested or no arguments
if [[ $# -eq 0 || "$1" == "-h" || "$1" == "--help" ]]; then
    show_help
    exit 0
fi

# Parse subcommand
subcommand="$1"
shift

# If the remaining args contain -h or --help, show cloudigv help (do not forward -h to subcommand)
for a in "$@"; do
    if [[ "$a" == "-h" || "$a" == "--help" ]]; then
        show_help
        exit 0
    fi
done

case "$subcommand" in
    -dropbox_URL)
        echo "Generating Dropbox URLs..."
        echo "Short options available: -k <key>  -f <folder>  -o <output_file>"
        python3 "$script_dir/generate_dropbox_links.py" "$@"
        ;;
    -igv_session_xml)
        echo "Generating IGV session XML..."
        python3 "$script_dir/generate_igv_session.py" "$@"
        ;;
    *)
        echo "Unknown subcommand: $subcommand"
        echo
        show_help
        exit 1
        ;;
esac
